<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Convertor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <div class=".container" >
        <form action="" onsubmit="return formValidation(event)">
            <label for="amount">Amount</label>
            <input id="amount" type="text"><br>
            <label for="fromCountry">From</label>
            <select name="from" id="fromCountry">
                
            </select><br>
            <label for="toCountry">To</label>
            <select name="to" id="toCountry">
                
            </select><br>
            <input type="submit" value="submit" >
        </form>
    </div>
    <div class="container">
        <h1 id="result"></h1>
    </div>
</body>
<script>
    var country = JSON.parse(localStorage.getItem("country")) ;
    const countryPopulator = function(optionId){
        const fragment = document.createDocumentFragment();
        country.forEach((countryCode) => {
            const option = document.createElement('option');
            $(option).prop("value" , countryCode) ;
            $(option).text(countryCode) ;
            fragment.append(option) ;
        });
        console.log(fragment) ;
        $(`#${optionId}`).append(fragment) ;
    }
    const formValidation = function(e){
        e.preventDefault() ;
        let amount = $("#amount").val() ;
        let fromCountry = $("#fromCountry :selected").text() ;
        let toCountry = $("#toCountry :selected").text() ;
        
        if(!amount.length || !Number(amount)) {
            alert("amount is not valid") ; 
            return ;
        }
        if(!fromCountry.length) { alert("plz select a FROM country") ; return ; } ; 
        if(!toCountry.length) { alert("plz select a TO country") ; return ;};
        if(fromCountry == toCountry) { alert("both the selected country are same") ; return ; } ;

        
        exchangeFunc(toCountry , fromCountry , amount) ;

        return false ;
    }

    const optionsFunc = function(){
        var myHeaders = new Headers();
        myHeaders.append("apikey", "JLTKjHHrd4USI0gqnqdLH2sQZQCOMx2d");

        var requestOptions = {
        method: 'GET',
        redirect: 'follow',
        headers: myHeaders
        };

        fetch("https://api.apilayer.com/exchangerates_data/symbols", requestOptions)
        .then(response => response.json())
        .then(result => {
            console.log(result) ;
            country = Object.keys({...result.symbols}) ;
            localStorage.setItem("country",  JSON.stringify(country));
        })
        .catch(error => console.log('error', error));
    }

    if(!country || !country.length){
        optionsFunc() ;
        console.log(country) ;
    }else{
        console.log("test123") ;
        countryPopulator("fromCountry") ;
        countryPopulator("toCountry") ;
    }

    
    const exchangeFunc = function(to , from , amount){
        var myHeaders = new Headers();
        myHeaders.append("apikey", "JLTKjHHrd4USI0gqnqdLH2sQZQCOMx2d");
    
        var requestOptions = {
        method: 'GET',
        redirect: 'follow',
        headers: myHeaders
        };
    
        fetch(`https://api.apilayer.com/exchangerates_data/convert?to=${to}&from=${from}&amount=${amount}`, requestOptions)
        .then(response => response.json())
        .then(result => {
            $("#result").text(result.result) ;
        })
        .catch(error => console.log('error', error));
    }
</script>
</html>